/*
 *	Michael
 *	yongjie@staff.sina.com.cn
 *	2014-07-15
 *	For DFZ_News_Article APP & UNION
 *	V1.0 include	{{DFZ_CMNT.js}}-{{DFZ_UNION.js}}-{{DFZ_FixedNav.js}}
*/
;(function($){$.ns("DFZ.UNION");DFZ.UNION.ZOOM=function(context,size){$(context).css("fontSize",size+"px")};DFZ.UNION.TAB=function(nav,block,cls){if(!nav||!block||$(nav).size()!=$(block).size())return;$(nav).each(function(i,v){$(v).hover(function(){if($(v).hasClass(cls))return;$(nav).removeClass(cls).eq(i).addClass(cls);$(block).css('display','none').eq(i).css('display','')})})};DFZ.UNION.HotKey=function(app_id,container){$.ajax({url:'http:\/\/mblogv2.city.sina.com.cn/interface/common/json_get_page_to_js.php',dataType:'jsonp',data:{t:'jsonp',url:'http:\/\/miniblog.match.sina.com.cn/topsearch/getTopwordsCat.php?sid=data_top',app_id:app_id},success:function(json){if(json.error==0){var _result=[];$.each(json.data.data.slice(0,8),function(i,v){var _order='<i class="i-num'+(i<3?' ii':'')+'">'+(i+1)+'</i>';var _item='<li><span>'+v.num+'</span>'+_order+'<a target="_blank" href="http:\/\/data.weibo.com/top/keyworddetail?keyword='+encodeURIComponent(v.word)+'">'+v.word+'</a></li>';_result.push(_item)});_result.length>0&&$(container).html(_result.join(''))}}})};DFZ.UNION.CommentRank=function(channel,container){var sort_hot=function(list,limit){var data=[];while(data.length<limit){var count=0,time=0,num=0;for(k in list){if(typeof list[k]=='undefined')continue;var tmp=list[k];if(tmp.total_count>count||(tmp.total_count==count&&(new Date(tmp.time)).valueOf()>time)){count=parseInt(tmp.total_count);num=k}};data.push(list[num]);delete list[num]};return data};$.getScript("http:\/\/comment5.news.sina.com.cn/hotnews/info?format=js&jsvar=hotnewsdata_day&channel="+channel+"&hotid="+channel+"_day",function(){hotnewsdata_day.result.hotnews=sort_hot(hotnewsdata_day.result.hotnews.slice(0,10),8);var _result=[];$.each(hotnewsdata_day.result.hotnews,function(i,v){if(v){var _order='<i class="i-num'+(i<3?' ii':'')+'">'+(i+1)+'</i>';var _item="<li>"+_order+"<em>"+v.total_count+"</em>| <a target=_blank href='"+v.url+"'>"+v.title+"</a></li>";_result.push(_item)}});_result.length>0&&$(container).html(_result.join(''))})};DFZ.UNION.WeiboLocal=function(option){var op=$.extend({container:'',id:'mWeiboHot',width:250,height:360,appkey:'',app_id:''},option||{});var _iframe=$('<iframe id="mWeiboHot" width="250" height="360" src="" scrolling="no" frameborder="0" allowTransparency="true" style="background:none;"></iframe>');document.domain='sina.com.cn';var iframeURL="height="+op.height+"&";iframeURL+="appkey="+op.appkey+"&";iframeURL+="app_id="+op.app_id;_iframe.attr({id:op.id,width:op.width,height:op.height,src:'http:\/\/city.sina.com.cn/js/83/2012/1025/36.html?'+encodeURIComponent(iframeURL),scrolling:'no',frameborder:0,allowTransparency:'true'}).css('background','none');_iframe.appendTo(op.container)};DFZ.UNION.FixedNav=new function(){var W=window;var reIE=/MSIE\s([^;]*)/;var browser={ie:0,loaded:false};(function(browser){function toNumber(str){var count=0;return parseFloat(str.replace(/\./g,function(){count++;return(count===1)?'.':''}))}var ua=(navigator&&navigator.userAgent)||'';var temp=ua.match(reIE);if(temp&&temp[1]){browser.ie=toNumber(temp[1])}})(browser);var addEvent=W.addEventListener?function(elem,type,fn){elem.addEventListener(type,fn,false)}:function(elem,type,fn){elem.attachEvent('on'+type,fn)};var getPosition=function(ele){var positionX=0;var positionY=0;while(ele!=null){positionX+=ele.offsetLeft;positionY+=ele.offsetTop;ele=ele.offsetParent}return{x:positionX,y:positionY}};var hasClass=function(elem,cls){var reg=new RegExp('(^|\\s)'+cls+'($|\\s)');return reg.test(elem.className)};var removeClass=function(elem,cls){var reg=new RegExp('(^|\\s)'+cls+'($|\\s)','g');elem.className=elem.className.replace(reg,' ')};var addClass=function(elem,cls){if(!hasClass(elem,cls)){elem.className+=' '+cls}};var viewData=function(){var e=0,l=0,i=0,g=0,f=0,m=0;var j=window,h=document,k=h.documentElement;e=k.clientWidth||h.body.clientWidth||0;l=j.innerHeight||k.clientHeight||h.body.clientHeight||0;g=h.body.scrollTop||k.scrollTop||j.pageYOffset||0;i=h.body.scrollLeft||k.scrollLeft||j.pageXOffset||0;f=Math.max(h.body.scrollWidth,k.scrollWidth||0);m=Math.max(h.body.scrollHeight,k.scrollHeight||0,l);return{scrollTop:g,scrollLeft:i,documentWidth:f,documentHeight:m,viewWidth:e,viewHeight:l}};return function(id,className){if(browser.ie!=6){var subShowTabContainerPos=null;var container=document.getElementById(id);subShowTabContainerPos=getPosition(container);addEvent(container,'click',function(){var vD=viewData();W.scrollTo(0,subShowTabContainerPos.y)});var footTop=$('#footer-wrap').size()>0&&$('#footer-wrap').offset().top;var vD=viewData();if(!footTop){if(vD.scrollTop>subShowTabContainerPos.y){addClass(container,className)}else{removeClass(container,className)}}else{if(vD.scrollTop>subShowTabContainerPos.y&&vD.scrollTop<footTop-60){addClass(container,className)}else{removeClass(container,className)}}var scrollTimeout=null;var scrollCallback=function(){var footTop=$('#footer-wrap').size()>0&&$('#footer-wrap').offset().top;var vD=viewData();var pos1=getPosition(container);if(pos1.y>subShowTabContainerPos.y){subShowTabContainerPos.y=pos1.y}if(!footTop){if(vD.scrollTop>subShowTabContainerPos.y){addClass(container,className)}else{removeClass(container,className)}}else{if(vD.scrollTop>subShowTabContainerPos.y&&vD.scrollTop<footTop-60){addClass(container,className)}else{removeClass(container,className)}}};addEvent(W,'scroll',function(){if(scrollTimeout)W.clearTimeout(scrollTimeout);scrollTimeout=W.setTimeout(scrollCallback,10)})}}};DFZ.UNION.CMNT_=new function(){var strLen=function(str){var l=escape(str),len;len=l.length-(l.length-l.replace(/\%u/g,"u").length)*4;l=l.replace(/\%u/g,"uu");len=len-(l.length-l.replace(/\%/g,"").length)*2;return len};var parse_str=function(str){if(str==undefined){return""}else{return str}};var _createCMNT=function(newsID){var html='<div class="comment-form m_comment">			<h3 class="s-tit"><a href="#" class="acor-pl" style="display:none">查看评论（<b class="mcom_num" data-comment="'+newsID+'"></b>）</a>网友评论</h3>			<p><textarea name="content" id="comment_content" class="textare-content"></textarea></p>			<div class="info" style="display:none;position: relative;line-height: 19px; color: rgb(153, 153, 153); top: -65px; left: 215px;  margin-top: -19px;">感谢您发表评论，您发表的评论将在管理员审核后发布</div>			<p class="clear send-tit2">				<a class="submit_comment fr" href="javascript:;">发 表</a>				<span style="display:none;"><a href="aaa" target="_blank" class="acor i_nick"></a><i class="wline">|</i><a href="javascript:;" class="i_logout">退出</a><input type="checkbox" class="input-tb" checked="checked" name="wb">同步到我的微博</span>				<span style="display:none;"><a href="javascript:;" class="i_login">登录</a><i class="wline">|</i><a href="javascript:;" class="i_reg">注册</a></span>		</p>	</div>';return html};var postToWeibo=function(wbMsg){var nt=$.trim(wbMsg.title);var nl=location.href.replace(/\.html.*$/,'.html');var wc='我评论了新闻【'+nt+'】：'+wbMsg.content;wc=wc.substr(0,(279-nl.length)/2)+' '+nl;$.ajax({type:"get",dataType:"jsonp",url:"http:\/\/mblogv2.city.sina.com.cn/interface/tcommonv2/cookie_auth/postaction/get_token.php",data:{t:'jsonp',app_id:wbMsg.app_id,site_id:900},success:function(data){if(!(data&&data.error=="0")){alert(data.errmsg);return}$.ajax({type:"get",data:{content:wc,app_id:wbMsg.app_id,site_id:900,token:data.token},dataType:"jsonp",url:"http:\/\/mblogv2.city.sina.com.cn/interface/tcommonv2/cookie_auth/postaction/json_add_mblog.php"})}})};var setNewsList=function(channel,newsid){if(!channel||!newsid)return'';if(newsid.match(/comos-/)||newsid.match(/\d+-\d+-\d+/)){newsid=newsid+':0'}else{newsid=newsid+':1'};return channel+':'+newsid};this.Init=function(params){this.Info=$.extend({container:".discuss-form",channel:"sic",newsid:"841-422-221609",baseJS:"http:\/\/comment.sinajs.cn/cmnt_bbs_v5.js",V5_HOST:"http:\/\/comment5.news.sina.com.cn",CMNTPOST_WSGI:"/cmnt/submit",postCharset:"gb2312"},params,{});var info=sinaSSOController.getSinaCookie();this.Info.user=false;if(info&&info.nick){this.Info.user=info.nick};$(this.Info.container).html(_createCMNT(this.Info.newsid));if(!this.Info.user){$('textarea,.submit_comment',this.Info.container).bind('click',function(){DFZ.APP.DialogLogin.open()});return};var _this=this;$('textarea',this.Info.container).bind('click',function(){$('.info',_this.Info.container).hide()});$(".submit_comment",_this.Info.container).live('click',function(){var content=$('textarea',_this.Info.container).val();var is2mb=$('input[name=wb]:checked',_this.Info.container).size();var param={channel:_this.Info.channel,newsid:_this.Info.newsid,user:_this.Info.user,content:content,url:location.href,format:'js',charset:'',is2mb:is2mb};_this._SUBMIT(param)})};this._POST=function(param){if(!this.Info.user){DFZ.APP.DialogLogin.open();return};param.channel=$.trim(param.channel);param.newsid=$.trim(param.newsid);param.content=$.trim(param.content);if(param.channel==""||param.newsid==""){return false};if(param.content==''){alert("评论不能为空！");return};if(strLen(param.content)>6000){if(!confirm("帖子最多可以输入3000个汉字，您输入的内容超长。您可以点击\"取消\"按钮，删减部分内容后再重新提交。或者点击\"确定\"按钮，只发表前3000汉字的内容。"))return false};if(!document.getElementById('cmnt_post_span')){var cmnt_post_span=document.createElement("span");cmnt_post_span.setAttribute("id","cmnt_post_span");cmnt_post_span.setAttribute("style","display:none");document.body.insertBefore(cmnt_post_span,null)};var cmnt_host=parse_str(this.Info.V5_HOST);var wsgi=parse_str(this.Info.CMNTPOST_WSGI);var charset=parse_str(this.Info.postCharset)?" accept-charset='"+this.Info.postCharset+"'":"";document.getElementById('cmnt_post_span').innerHTML="<iframe name='cmnt_post_frame' style='display:none' width=0 height=0></iframe><form name='cmnt_post_form' action='"+cmnt_host+wsgi+"' method='post' target='cmnt_post_frame'"+charset+"><input type=hidden name=anonymous value=1><input type=hidden name=channel><input type=hidden name=newsid><input type=hidden name=content><input type=hidden name=user><input type=hidden name=url><input type=hidden name=format><input type=hidden name=charset></form>";document.cmnt_post_form.channel.value=param.channel;document.cmnt_post_form.newsid.value=param.newsid;document.cmnt_post_form.content.value=param.content;document.cmnt_post_form.user.value=parse_str(param.user);document.cmnt_post_form.url.value=parse_str(param.url);document.cmnt_post_form.format.value=parse_str(param.format);document.cmnt_post_form.charset.value=parse_str(param.charset);document.cmnt_post_form.submit();return true};this._SUBMIT=function(param){if(this._POST(param)){$('textarea',this.Info.container).val('').blur();$('.info',this.Info.container).show()};if(param.is2mb){postToWeibo({title:$('h1:first').text(),content:param.content,app_id:DFZ.CFG.appid})}};this.getCount=function(option,callback){var op=$.extend({channel:'fsh',newsId:['comos-anfzhnx8364005']},option||{});var newslist;if(typeof op.newsId=='string'){newslist=op.newsId}else{newslist=[];$(op.newsId).each(function(i,val){var item_=setNewsList(op.channel,val);item_&&newslist.push(item_)});newslist=newslist.join()};var ajax_sets={};ajax_sets.url="http:\/\/comment5.news.sina.com.cn/cmnt/count?format=js&newslist="+newslist;ajax_sets.dataType="script";ajax_sets.data={};ajax_sets.success=function(){var _data=data.result;if(_data.status.code!=0)return;callback&&callback(_data.count)};$.ajax(ajax_sets)}}})(jQuery);